import{m as p,f as o,k as d,R as b,C as h,j as u}from"./index-Dnfjscuv.js";import{C as m}from"./camera-BkgcWKh1.js";var f=Object.defineProperty,C=Object.getOwnPropertyDescriptor,l=(c,e,t,r)=>{for(var a=r>1?void 0:r?C(e,t):e,s=c.length-1,i;s>=0;s--)(i=c[s])&&(a=(r?i(e,t,a):i(a))||a);return r&&a&&f(e,t,a),a};let n=class extends p(m){cameraVideo;pc=null;ws=null;playbackAbortController=null;sleepAbortController=null;loadStream(){try{this.pc?.close(),this.ws?.close();const e=this.playbackAbortController?.signal;if(!e||e.aborted)return;this.updateStatus("connecting");const t=this.buildAbsoluteUrl(this.camera.stream_url||""),r=new URL("api/ws"+t.search,t);r.protocol=r.protocol==="https:"?"wss:":"ws:",this.ws=new WebSocket(r),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onWebSocketOpen,this.ws.onmessage=this.onWebSocketMessage,this.ws.onclose=this.onWebSocketClose,this.updateRawCameraUrl(t.toString())}catch(e){o.error(`[WebrtcGo2RtcCamera] failed to start playback "${this.camera.name}"`,e)}}async onWebSocketOpen(){o.debug("[WebrtcGo2RtcCamera] socket opened");const e={bundlePolicy:"max-bundle",iceServers:[{urls:"stun:stun.l.google.com:19302"}],sdpSemantics:"unified-plan"};this.pc=new RTCPeerConnection(e),this.pc.onicecandidate=a=>{if(!a.candidate)return;const s={type:"webrtc/candidate",value:a.candidate.toJSON().candidate};this.ws?.send(JSON.stringify(s))},this.pc.onconnectionstatechange=()=>{switch(this.pc?.connectionState){case"connected":{const a=this.pc.getTransceivers().filter(s=>s.direction==="recvonly").map(s=>s.receiver.track);this.cameraVideo.srcObject=new MediaStream(a);break}case"failed":case"disconnected":this.loadStream()}},this.pc.addTransceiver("video",{direction:"recvonly"});const t=await this.pc.createOffer();await this.pc.setLocalDescription(t);const r={type:"webrtc/offer",value:t.sdp};this.ws?.send(JSON.stringify(r))}async onWebSocketMessage(e){const t=JSON.parse(e.data);switch(t.type){case"webrtc/candidate":try{await this.pc?.addIceCandidate({candidate:t.value,sdpMid:"0"})}catch(r){o.warn("[WebrtcGo2RtcCamera] RTCPeerConnection.addIceCandidate() error",r)}break;case"webrtc/answer":try{this.pc?.setRemoteDescription({type:"answer",sdp:t.value})}catch(r){o.warn("[WebrtcGo2RtcCamera] RTCPeerConnection.setRemoteDescription() error",r)}break;case"error":o.error(`[WebrtcGo2RtcCamera] ${t.value}`),this.updateStatus("error"),this.pc?.close()}}async onWebSocketClose(e){if(!e.wasClean){this.updateStatus("error"),o.error("[WebrtcGo2RtcCamera] socket close was not clean",e);const t=this.playbackAbortController?.signal;if(!t||t.aborted)return;this.sleepAbortController?.abort();const r=this.sleepAbortController=new AbortController;try{const a=[t,r.signal];await d(2e3,AbortSignal.any(a)),this.loadStream()}catch{}}}startPlayback(){this.playbackAbortController=new AbortController,this.loadStream()}stopPlayback(){this.playbackAbortController?.abort(),this.playbackAbortController=null,this.updateStatus("disconnected"),this.pc&&(this.pc.getSenders().forEach(e=>{e.track?.stop()}),this.pc.close(),this.pc=null),this.ws?.close(),this.ws=null,this.cameraVideo.src="",this.cameraVideo.srcObject=null}};l([b("streamingElement")],n.prototype,"cameraVideo",2);n=l([h({})],n);var w=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("video",{ref:"streamingElement",style:e.cameraStyle,attrs:{autoplay:"",disablePictureInPicture:"",playsinline:"",muted:"",crossorigin:e.crossorigin},domProps:{muted:!0},on:{play:function(r){return e.updateStatus("connected")},error:function(r){return e.updateStatus("error")}}})},y=[],S=u(n,w,y,!1,null,null);const _=S.exports;export{_ as default};
