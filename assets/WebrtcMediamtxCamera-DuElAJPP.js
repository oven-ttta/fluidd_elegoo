import{m as h,f as c,R as u,C as m,j as f}from"./index-Dnfjscuv.js";import{C as p}from"./camera-BkgcWKh1.js";var w=Object.defineProperty,C=Object.getOwnPropertyDescriptor,l=(o,e,t,r)=>{for(var s=r>1?void 0:r?C(e,t):e,a=o.length-1,i;a>=0;a--)(i=o[a])&&(s=(r?i(e,t,s):i(s))||s);return r&&s&&w(e,t,s),s};let d=class extends h(p){cameraVideo;whepUrl="";sessionUrl="";pc=null;restartTimeout=null;offerData=null;queuedCandidates=[];unquoteCredential(e){return JSON.parse(`"${e}"`)}linkToIceServers(e){return e!==null?e.split(", ").map(t=>{const r=t.match(/^<(.+?)>; rel="ice-server"(; username="(.*?)"; credential="(.*?)"; credential-type="password")?/i),s={urls:[r[1]]};return r[3]!==void 0&&(s.username=this.unquoteCredential(r[3]),s.credential=this.unquoteCredential(r[4]),s.credentialType="password"),s}):[]}parseOffer(e){const t={iceUfrag:"",icePwd:"",medias:[]};for(const r of e.split(`\r
`))r.startsWith("m=")?t.medias.push(r.slice(2)):t.iceUfrag===""&&r.startsWith("a=ice-ufrag:")?t.iceUfrag=r.slice(12):t.icePwd===""&&r.startsWith("a=ice-pwd:")&&(t.icePwd=r.slice(10));return t}generateSdpFragment(e,t){const r={};for(const i of t){const n=i.sdpMLineIndex;r[n]===void 0&&(r[n]=[]),r[n].push(i)}let s="a=ice-ufrag:"+e.iceUfrag+`\r
a=ice-pwd:`+e.icePwd+`\r
`,a=0;for(const i of e.medias){if(r[a]!==void 0){s+="m="+i+`\r
a=mid:`+a+`\r
`;for(const n of r[a])s+="a="+n.candidate+`\r
`}a++}return s}async loadStream(){try{this.updateStatus("connecting");const e=await fetch(this.whepUrl,{method:"OPTIONS"}),t={iceServers:this.linkToIceServers(e.headers.get("Link")),sdpSemantics:"unified-plan"};this.pc=new RTCPeerConnection(t),this.pc.addTransceiver("video",{direction:"recvonly"}),this.pc.onicecandidate=s=>{this.restartTimeout===null&&s.candidate!==null&&(this.sessionUrl===""?this.queuedCandidates.push(s.candidate):this.sendLocalCandidates([s.candidate]))},this.pc.oniceconnectionstatechange=()=>{this.restartTimeout===null&&this.pc?.iceConnectionState==="disconnected"&&(c.warn("[WebrtcMediamtxCamera] peer connection disconnected"),this.onError())},this.pc.ontrack=s=>{this.cameraVideo.srcObject=s.streams[0]};const r=await this.pc.createOffer();this.offerData=this.parseOffer(r.sdp??""),this.pc.setLocalDescription(r),this.sendOffer(r)}catch(e){c.error(`[WebrtcMediamtxCamera] error on loadStream "${this.camera.name}"`,e),this.onError()}}onError(){this.updateStatus("error"),this.restartTimeout===null&&(this.pc!==null&&(this.pc.close(),this.pc=null),this.restartTimeout=window.setTimeout(()=>{this.restartTimeout=null,this.loadStream()},2e3),this.sessionUrl&&(fetch(this.sessionUrl,{method:"DELETE"}),this.sessionUrl=""),this.queuedCandidates=[])}async sendLocalCandidates(e){try{const t=await fetch(this.sessionUrl,{method:"PATCH",headers:{"Content-Type":"application/trickle-ice-sdpfrag","If-Match":"*"},body:this.generateSdpFragment(this.offerData,e)});switch(t.status){case 204:break;case 404:throw new Error("stream not found");default:throw new Error(`bad status code ${t.status}`)}}catch(t){c.error("[WebrtcMediamtxCamera] error on sendLocalCandidates",t),this.onError()}}onRemoteAnswer(e){this.restartTimeout===null&&(this.pc?.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e})),this.queuedCandidates.length!==0&&(this.sendLocalCandidates(this.queuedCandidates),this.queuedCandidates=[]))}async sendOffer(e){try{const t=await fetch(this.whepUrl,{method:"POST",headers:{"Content-Type":"application/sdp"},body:e.sdp});switch(t.status){case 201:break;case 404:throw new Error("stream not found");default:throw new Error(`bad status code ${t.status}`)}this.sessionUrl=new URL(t.headers.get("location")??"",this.baseUrl).toString();const r=await t.text();this.onRemoteAnswer(r)}catch(t){c.error("[WebrtcMediamtxCamera] error on sendOffer",t),this.onError()}}get baseUrl(){const e=this.buildAbsoluteUrl(this.camera.stream_url||"");return e.pathname.endsWith("/")||(e.pathname+="/"),e}startPlayback(){this.whepUrl=new URL("whep",this.baseUrl).toString(),this.loadStream()}stopPlayback(){this.updateStatus("disconnected"),this.sessionUrl="",this.queuedCandidates=[],this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null),this.pc&&(this.pc.close(),this.pc=null),this.cameraVideo.src="",this.cameraVideo.srcObject=null}};l([u("streamingElement")],d.prototype,"cameraVideo",2);d=l([m({})],d);var g=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("video",{ref:"streamingElement",style:e.cameraStyle,attrs:{autoplay:"",disablePictureInPicture:"",playsinline:"",muted:"",crossorigin:e.crossorigin},domProps:{muted:!0},on:{play:function(r){return e.updateStatus("connected")},error:function(r){return e.updateStatus("error")}}})},b=[],y=f(d,g,b,!1,null,null);const v=y.exports;export{v as default};
