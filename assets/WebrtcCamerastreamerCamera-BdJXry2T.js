import{m as u,f as d,k as m,R as h,C as y,j as b}from"./index-Dnfjscuv.js";import{C as f}from"./camera-BkgcWKh1.js";var C=Object.defineProperty,S=Object.getOwnPropertyDescriptor,p=(c,e,r,t)=>{for(var a=t>1?void 0:t?S(e,r):e,s=c.length-1,o;s>=0;s--)(o=c[s])&&(a=(t?o(e,r,a):o(a))||a);return t&&a&&C(e,r,a),a};const v=[{urls:["stun:stun.l.google.com:19302"]}];let l=class extends u(f){cameraVideo;pc=null;remoteId=null;playbackAbortController=null;sleepAbortController=null;sendIceServers=!0;async loadStream(){this.pc?.close();const e=this.playbackAbortController?.signal;if(!e||e.aborted)return;this.updateStatus("connecting");const r=this.buildAbsoluteUrl(this.camera.stream_url||"");this.updateRawCameraUrl(r.toString());try{const t=await this.sendInitialRequest(r,e);this.remoteId="id"in t&&typeof t.id=="string"?t.id:null;const a={sdpSemantics:"unified-plan"};"iceServers"in t&&Array.isArray(t.iceServers)&&(a.iceServers=t.iceServers);const s=this.pc=new RTCPeerConnection(a);s.ondatachannel=n=>{const i=n.channel;i.label==="keepalive"&&(i.onmessage=()=>{i.send("pong")})},s.addTransceiver("video",{direction:"recvonly"}),s.ontrack=n=>{n.track.kind==="video"&&(this.cameraVideo.srcObject=n.streams[0])},a.iceServers&&(s.onicecandidate=async n=>{if(n.candidate)try{await this.sendRemoteCandidatesRequest(r,[n.candidate],e)}catch(i){d.error("[WebrtcCamerastreamerCamera] onicecandidate",i)}}),await s.setRemoteDescription(t);const o=await s.createAnswer();await s.setLocalDescription(o),s.localDescription&&await this.sendOfferRequest(r,s.localDescription,e)}catch(t){d.error(`[WebrtcCamerastreamerCamera] failed to start playback "${this.camera.name}"`,t),this.onError()}}async onError(){this.updateStatus("error"),this.pc?.close(),this.pc=null;const e=this.playbackAbortController?.signal;if(!e||e.aborted)return;this.sleepAbortController?.abort();const r=this.sleepAbortController=new AbortController;try{const t=[e,r.signal];await m(2e3,AbortSignal.any(t)),this.loadStream()}catch{}}async startPlayback(){this.playbackAbortController=new AbortController,await this.loadStream()}async sendInitialRequest(e,r){try{const t=await fetch(e,{body:JSON.stringify({type:"request",...this.sendIceServers?{iceServers:v}:void 0,keepAlive:!0}),headers:{"Content-Type":"application/json"},method:"POST",signal:r});return await this.ensureResponseOk(t,"application/json"),await t.json()}catch(t){throw r.aborted||t instanceof Error&&t.name==="AbortError"||(this.sendIceServers=!this.sendIceServers),t}}async sendRemoteCandidatesRequest(e,r,t){const a=await fetch(e,{body:JSON.stringify({type:"remote_candidate",id:this.remoteId,candidates:r}),headers:{"Content-Type":"application/json"},method:"POST",signal:t});await this.ensureResponseOk(a)}async sendOfferRequest(e,r,t){const a=await fetch(e,{body:JSON.stringify({type:r.type,id:this.remoteId,sdp:r.sdp}),headers:{"Content-Type":"application/json"},method:"POST",signal:t});await this.ensureResponseOk(a)}async ensureResponseOk(e,r){const t=e.headers.get("Content-Type");if(!(e.ok&&(!r||t?.includes(r)))){const s=await e.text();throw new Error(`Invalid response! Status: ${e.status}, Content-Type: ${t}, Body: ${s}`)}}stopPlayback(){this.updateStatus("disconnected"),this.playbackAbortController?.abort(),this.playbackAbortController=null,this.pc?.close(),this.pc=null,this.cameraVideo.src="",this.cameraVideo.srcObject=null}};p([h("streamingElement")],l.prototype,"cameraVideo",2);l=p([y({})],l);var w=function(){var e=this,r=e._self._c;return e._self._setupProxy,r("video",{ref:"streamingElement",style:e.cameraStyle,attrs:{autoplay:"",disablePictureInPicture:"",playsinline:"",muted:"",crossorigin:e.crossorigin},domProps:{muted:!0},on:{play:function(t){return e.updateStatus("connected")},error:function(t){return e.updateStatus("error")}}})},g=[],_=b(l,w,g,!1,null,null);const R=_.exports;export{R as default};
